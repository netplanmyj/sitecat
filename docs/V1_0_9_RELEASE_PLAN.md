# v1.0.9 Release Plan

> **ãƒªãƒªãƒ¼ã‚¹äºˆå®š**: 2025å¹´12æœˆä¸‹æ—¬  
> **ç›®çš„**: ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Šã¨ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ‹¡å¤§  
> **å¯¾è±¡**: TestFlight â†’ App Store

> æ³¨è¨˜: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®æ›´æ–°ï¼ˆpubspec.yamlï¼‰ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚
> ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ v1.0.9+78 ã§ã™ï¼ˆå¯©æŸ»æå‡ºç”¨ï¼‰ã€‚

---

## æ¦‚è¦

v1.0.9ã§ã¯ã€Phase 3bã«å‘ã‘ãŸåŸºç›¤æ•´å‚™ã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã®ä¿å®ˆæ€§å‘ä¸Šã¨ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ”¹å–„ã‚’è¡Œã„ã¾ã™ã€‚

---

## ãƒªãƒªãƒ¼ã‚¹ç›®æ¨™

### ä¸»è¦ç›®æ¨™
1. âœ… TestFlightãƒ“ãƒ«ãƒ‰101ã§èª²é‡‘æ©Ÿèƒ½ã®å®Ÿæ©Ÿç¢ºèªå®Œäº†
2. ğŸ”² ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 32% â†’ 50%ä»¥ä¸Š
3. ğŸ”² ã‚³ãƒ¼ãƒ‰é‡è¤‡: 8% â†’ 6%ä»¥ä¸‹
4. ğŸ”² é‡è¦ãªãƒã‚°ä¿®æ­£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

### å‰¯æ¬¡ç›®æ¨™
- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®‰å®šåŒ–
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
- é–‹ç™ºè€…ä½“é¨“ã®å‘ä¸Š

---

## å®Ÿæ–½ã‚¿ã‚¹ã‚¯ï¼ˆå„ªå…ˆé †ä½é †ï¼‰

### Phase 1: ã‚µãƒ¼ãƒãƒ¼å´ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ– ğŸ”´ CRITICAL

**æœŸé–“**: 1.5-2é€±é–“  
**è¤‡é›‘åº¦**: â­â­â­â­ï¼ˆé«˜ï¼‰

#### Task 1.1: Firestore Security Rules å¼·åŒ– - Issue #300 ä»£æ›¿æ¡ˆ **MUST**
**å„ªå…ˆåº¦**: P0 ğŸ”´  
**å·¥æ•°**: 30åˆ†  
**åˆ¤æ–­**: **MUST** - Security Rules å¼·åŒ–ã§ååˆ†ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿

**å®Ÿè£…ç†ç”±:**
1. **StoreKit 2 ã®ä¿¡é ¼æ€§**: Apple å…¬å¼ã‚·ã‚¹ãƒ†ãƒ ã§æ—¢ã«ååˆ†ã«å …ç‰¢
2. **è„…å¨ã®è©•ä¾¡**: è²·ã„åˆ‡ã‚Š Â¥1,200 ã§ä¸æ­£è³¼å…¥ã®ãƒªã‚¹ã‚¯é™å®šçš„
3. **å®Ÿè£…ã‚³ã‚¹ãƒˆ**: Issue #300 (3-5æ—¥) vs Security Rules (30åˆ†)
4. **App Store å¯©æŸ»**: ç¾çŠ¶ã®ã‚·ã‚¹ãƒ†ãƒ ã§å¯©æŸ»é€šéæ¸ˆã¿

**å®Ÿè£…å†…å®¹:**
```javascript
// firestore.rules
match /users/{userId}/subscription/{purchaseId} {
  allow read: if request.auth.uid == userId;
  allow create: if request.auth.token.admin == true;
  allow update, delete: if false;
}
```

**æˆæœç‰©:**
- âœ… Firestore Security Rules å¼·åŒ–
  - subscription ã®æ›¸ãè¾¼ã¿ã‚’ Cloud Function ã®ã¿ã«åˆ¶é™
  - èª­ã¿å–ã‚Šã¯æœ¬äººã®ã¿ã«åˆ¶é™
  - è³¼å…¥æƒ…å ±ã®æ›´æ–°ãƒ»å‰Šé™¤ã‚’ç¦æ­¢
- âœ… dev/prod ä¸¡ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤

**v1.1 ä»¥é™ã§ã®æ¤œè¨äº‹é …:**
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½è¿½åŠ æ™‚ã« Apple App Store Server API å°å…¥ã‚’æ¤œè¨
- é«˜é¡èª²é‡‘ãƒ—ãƒ©ãƒ³ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã¯å®Œå…¨ãªãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼ã‚’å†è©•ä¾¡

---

#### Task 1.2: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³çš„ãªã‚µã‚¤ãƒˆä½œæˆ - Issue #299 **DEFERRED**
**å„ªå…ˆåº¦**: P0 â†’ P1 (å„ªå…ˆåº¦ä¸‹ã’)  
**å·¥æ•°**: 2-3æ—¥  
**åˆ¤æ–­**: **DEFERRED to v1.1** - ç¾çŠ¶ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¤œè¨¼ã§ååˆ†

**å»¶æœŸç†ç”±:**
1. **ç¾çŠ¶ã®å¯¾ç­–**: SiteProvider ã§ `canAddSite` ãƒã‚§ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿
2. **ç™ºç”Ÿé »åº¦**: ç«¶åˆæ¡ä»¶ã¯æ¥µã‚ã¦ç¨€
3. **å®Ÿè£…ã‚³ã‚¹ãƒˆ**: 2-3æ—¥ã®å·¥æ•°ãŒå¿…è¦
4. **å„ªå…ˆé †ä½**: Security Rules å¼·åŒ–ã‚’å„ªå…ˆ

**v1.0.9 ã§ã®å¯¾å¿œ:**
- âœ… ç¾çŠ¶ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¤œè¨¼ã‚’ç¶­æŒ
- âœ… Security Rules ã§ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ä¿è¨¼

**v1.1 ã§ã®å®Ÿè£…æ¤œè¨:**
- Cloud Function ã«ã‚ˆã‚‹åŸå­çš„ãªã‚µã‚¤ãƒˆä½œæˆ
- Firestore Transaction ã«ã‚ˆã‚‹ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†

---

#### Task 1.3: Cloud Functions ãƒ†ã‚¹ãƒˆ - Issue #301 **SHOULD**
**å„ªå…ˆåº¦**: P1 âš ï¸  
**å·¥æ•°**: 2æ—¥  
**åˆ¤æ–­**: **SHOULD** - ãƒ†ã‚¹ãƒˆé§†å‹•ã§ä¿¡é ¼æ€§å‘ä¸Š

**ç†ç”±:**
- Task 1.1, 1.2 ã®æ­£ç¢ºæ€§æ¤œè¨¼ã«å¿…é ˆ
- CI/CD ã§ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆåŒ–
- è¤‡é›‘åº¦ã¯ä½ã„ï¼ˆâ­â­ï¼‰

**å®Ÿè£…å†…å®¹:**
```typescript
// functions/test/limit.test.ts
describe('Site Limit Enforcement', () => {
  test('free user: max 3 sites', async () => { ... });
  test('premium user: max 30 sites', async () => { ... });
  test('reject over-limit create', async () => { ... });
});

// functions/test/verify.test.ts
describe('Receipt Verification', () => {
  test('valid receipt accepted', async () => { ... });
  test('invalid receipt rejected', async () => { ... });
});
```

**æˆæœç‰©:**
- Cloud Functions ã®å˜ä½“ãƒ†ã‚¹ãƒˆ
- ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ã‚«ãƒãƒ¬ãƒƒã‚¸

---

### Phase 2: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š âš ï¸ HIGH

**æœŸé–“**: 1.5é€±é–“  
**è¤‡é›‘åº¦**: â­â­ï¼ˆä½ï¼‰

#### Task 2.1: ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè£… - Issue #311 **SHOULD**
**å„ªå…ˆåº¦**: P1 âš ï¸  
**å·¥æ•°**: 1æ—¥  
**åˆ¤æ–­**: **SHOULD** - Issue #312 ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨åŠ¹æœå¤§

**ç†ç”±:**
- è³¼å…¥å®Œäº†ãƒãƒ¼ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¬ è½
- Issue #312 ã§è¿½åŠ ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ¤œè¨¼ã«å¿…é ˆ
- å®Ÿè£…ãŒç°¡å˜ï¼ˆâ­â­ï¼‰

**å®Ÿè£…å†…å®¹:**
```dart
// test/providers/subscription_provider_test.dart ã«è¿½åŠ 
testWidgets('polling returns immediately when purchase confirmed', (tester) async {
  // Mock: _hasLifetimeAccess ãŒ 2å›ç›®ã§ true ã«
  // æ¤œè¨¼: 2ç§’ä»¥å†…ã«å®Œäº†
});

testWidgets('polling times out after 10 seconds', (tester) async {
  // Mock: _hasLifetimeAccess ãŒå¸¸ã« false
  // æ¤œè¨¼: ç´„10ç§’å¾Œã«å®Œäº†
});

testWidgets('polls at 1 second intervals', (tester) async {
  // æ¤œè¨¼: æ­£ç¢ºã« 1 ç§’é–“éš”
});
```

**æˆæœç‰©:**
- 4ã¤ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
- ãƒãƒ¼ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å®Œå…¨ã‚«ãƒãƒ¬ãƒƒã‚¸

---

#### Task 2.2: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã¨ UI - Issue #312 **SHOULD**
**å„ªå…ˆåº¦**: P1 âš ï¸  
**å·¥æ•°**: 1-2æ—¥  
**åˆ¤æ–­**: **SHOULD** - UX æ”¹å–„ã€Issue #311 ã¨åŒæ™‚å®Ÿè£…æ¨å¥¨

**ç†ç”±:**
- è³¼å…¥å®Œäº†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¬ è½
- ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã®ã¿ï¼‰
- Issue #311 ã¨ã‚»ãƒƒãƒˆå®Ÿè£…ã§åŠ¹æœé«˜

**å®Ÿè£…å†…å®¹:**
```dart
// lib/providers/subscription_provider.dart
Future<void> _waitForPurchaseCompletion() async {
  // ... ãƒãƒ¼ãƒªãƒ³ã‚°å‡¦ç† ...
  
  if (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ) {
    _error = 'è³¼å…¥ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚'
             'ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã”ç¢ºèªãã ã•ã„ã€‚';
    notifyListeners();
  }
}

// lib/screens/purchase_screen.dart
if (provider.error != null) {
  showErrorDialog(provider.error!);
}
```

**æˆæœç‰©:**
- Issue #311 ã®ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆåŒæ™‚ï¼‰
- UI ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

---

### Phase 3: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„ ğŸŸ¡ MEDIUM

**æœŸé–“**: 2-3æ—¥  
**è¤‡é›‘åº¦**: â­â­â­ï¼ˆä¸­ï¼‰

#### Task 3.1: Build method ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ä¿®æ­£ - Issue #313 **COMPLETED** âœ…
**å„ªå…ˆåº¦**: P2  
**å·¥æ•°**: 2æ—¥  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **å®Œäº†** - ProvideråŒæœŸã‚’ `initState()` ã«ç§»å‹•

**å®Ÿè£…å®Œäº†å†…å®¹:**
- âœ… `sites_screen.dart`: ProvideråŒæœŸã‚’ `build()` â†’ `initState()` ã«ç§»å‹•
- âœ… `site_form_screen.dart`: ProvideråŒæœŸã‚’ `build()` â†’ `initState()` ã«ç§»å‹•
- âœ… `purchase_screen.dart`: ProvideråŒæœŸã‚’ `build()` â†’ `initState()` ã«ç§»å‹•ï¼ˆrace condition ä¿®æ­£å«ã‚€ï¼‰
- âœ… `site_provider.dart`: `initializeFromSubscription()` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 

**å‰Šé™¤äºˆå®š:**
- ğŸ”² `purchase_provider.dart`: ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆæ¬¡ã®ã‚³ãƒŸãƒƒãƒˆã§å¯¾å¿œï¼‰

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
1. `purchase_provider.dart` å‰Šé™¤
2. å…¨409ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ç¢ºèª
3. å®Ÿæ©Ÿå‹•ä½œç¢ºèª

---

### Phase 4: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒŠãƒ©ã‚¤ã‚º ğŸ“

**æœŸé–“**: 2-3æ—¥  
**æ‹…å½“**: é–‹ç™ºãƒãƒ¼ãƒ 

#### Task 4.1: Release Notes ä½œæˆ
**å„ªå…ˆåº¦**: P1  
**å·¥æ•°**: 1æ™‚é–“

**è¨˜è¼‰å†…å®¹:**
```markdown
## [1.0.9] - 2025-01-15

### ğŸ” Security
- âœ… Apple receipt server-side verification (Issue #300)
- âœ… Transactional site creation to prevent duplicates (Issue #299)

### ğŸ§ª Testing
- âœ… Cloud Functions comprehensive tests (Issue #301)
- âœ… Purchase polling tests (Issue #311)

### ğŸ— Architecture
- âœ… Build method anti-pattern fixed (Issue #313)
- âœ… Purchase timeout error handling (Issue #312)

### ğŸ“Š Metrics
- Test coverage: 32% â†’ 48%
- New test cases: +20 tests
- Zero known security gaps
```

---

#### Task 4.2: CHANGELOG.md æ›´æ–°
**å„ªå…ˆåº¦**: P1  
**å·¥æ•°**: 30åˆ†

#### Task 4.3: TestFlight é…å¸ƒæº–å‚™
**å„ªå…ˆåº¦**: P1  
**å·¥æ•°**: 1-2æ™‚é–“  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… Testing Guide å®Œäº†

**æˆæœç‰©:**
- Build 108 é…å¸ƒæº–å‚™
- ãƒ†ã‚¹ã‚¿ãƒ¼é€šçŸ¥æ–‡ä½œæˆ
- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†ãƒ•ã‚©ãƒ¼ãƒ 

---

## ãƒªãƒªãƒ¼ã‚¹æˆåŠŸåŸºæº– âœ…

### MUSTï¼ˆå¿…é ˆæ¡ä»¶ï¼‰
- ğŸ”² Task 1.1 å®Ÿè£…å®Œäº†ï¼ˆSecurity Rules å¼·åŒ–ï¼‰ â† **NEW**
- ğŸ”² å…¨409ãƒ†ã‚¹ãƒˆé€šé
- ğŸ”² `flutter analyze` æˆåŠŸ
- ğŸ”² `dart format --check` æˆåŠŸ
- ğŸ”² CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æˆåŠŸ

### SHOULDï¼ˆæ¨å¥¨ï¼‰
- ğŸ”² Issue #311 å®Ÿè£…å®Œäº†ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼‰
- ğŸ”² Issue #312 å®Ÿè£…å®Œäº†ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼‰
- âœ… Issue #313 å®Ÿè£…å®Œäº†ï¼ˆBuild method ä¿®æ­£ï¼‰
- ğŸ”² TestFlight Build 108 é…å¸ƒå®Œäº†

### DEFERREDï¼ˆå»¶æœŸï¼‰
- âŒ Issue #300 (Apple receipt verification) â†’ v1.1
  - **ç†ç”±**: Security Rules å¼·åŒ–ã§ååˆ†ã€å®Ÿè£…ã‚³ã‚¹ãƒˆ 3-5æ—¥
- âŒ Issue #299 (Transactional creation) â†’ v1.1
  - **ç†ç”±**: ç¾çŠ¶ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¤œè¨¼ã§ååˆ†ã€ç«¶åˆæ¡ä»¶ã¯ç¨€
- âŒ Issue #301 (Cloud Functions tests) â†’ v1.1
  - **ç†ç”±**: Issue #299/#300 å»¶æœŸã«ã‚ˆã‚Šä¸è¦
- âŒ Issue #210 (Request-level validation) â†’ v1.2+
  - **ç†ç”±**: è¤‡é›‘åº¦ â­â­â­â­â­ã€åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯è§£æ±ºæ¸ˆã¿

---

## å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Week 1: Security Rules å¼·åŒ– + ãƒ†ã‚¹ãƒˆï¼ˆç›®æ¨™: 2æ—¥ï¼‰

**Day 1: Security Rules å®Ÿè£…**
```
Morning: Security Rules æ›´æ–°
Afternoon: dev ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»å‹•ä½œç¢ºèª
```

**Day 2: ãƒ†ã‚¹ãƒˆ + æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤**
```
Morning: å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ç¢ºèª
Afternoon: prod ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
Evening: å®Ÿæ©Ÿç¢ºèª
```

### Week 2: TestFlight é…å¸ƒï¼ˆç›®æ¨™: 2-3æ—¥ï¼‰

**Days 3-4: TestFlight Build 108**
```
Day 3: Xcode Cloud ã§ãƒ“ãƒ«ãƒ‰
Day 4: TestFlight é…å¸ƒã€ãƒ™ãƒ¼ã‚¿ãƒ†ã‚¹ã‚¿ãƒ¼é€šçŸ¥
```

**Day 5: App Store å¯©æŸ»æº–å‚™**
```
ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆæœ€çµ‚ç¢ºèª
å¯©æŸ»æå‡ºæº–å‚™
```

**ãƒªãƒªãƒ¼ã‚¹äºˆå®šæ—¥**: 2025å¹´12æœˆä¸‹æ—¬

---

## æˆåŠŸæŒ‡æ¨™

### ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™
- âœ… Security Rules å¼·åŒ–å®Œäº†
- âœ… å…¨409ãƒ†ã‚¹ãƒˆé€šé
- âœ… CI/CDæˆåŠŸç‡: 100%
- âœ… å®Ÿè£…å·¥æ•°: 30åˆ†ï¼ˆè¨ˆç”»é€šã‚Šï¼‰

### ãƒ“ã‚¸ãƒã‚¹æŒ‡æ¨™
- App Storeå¯©æŸ»é€šé
- ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ç‡: <0.1%
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ä¸å…·åˆå ±å‘Š: 0ä»¶
- TestFlightæº€è¶³åº¦: é«˜è©•ä¾¡

---

**è¨ˆç”»ç­–å®š**: 2025å¹´12æœˆ19æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ20æ—¥  
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: 2025å¹´12æœˆ27æ—¥
