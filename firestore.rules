rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザーコレクション - 階層構造のルートレベル
    match /users/{userId} {
      // ユーザープロフィールへのアクセス（自分のみ）
      allow read: if request.auth != null && request.auth.uid == userId;

      // ユーザープロフィールの書き込み（siteCount/isPremium はサーバー専用 - クライアント書き込み禁止）
      allow write: if request.auth != null
        && request.auth.uid == userId
        && (
          request.resource.data == null // delete のみ許可
          || (
            // 他の更新時（siteCount/isPremium を含まない）
            !request.resource.data.keys().hasAny(['siteCount', 'isPremium'])
          )
        );

      // プラン判定（サーバー側で保持する購読ドキュメントを参照）
      function isPremiumUser() {
        let subPath = /databases/$(database)/documents/users/$(userId)/subscription/lifetime;
        return exists(subPath) && get(subPath).data.isActive == true;
      }

      // サイト数上限（無料3 / 有料30）
      function siteCreationAllowed() {
        let userPath = /databases/$(database)/documents/users/$(userId);
        // ユーザードキュメントが存在し、siteCount が有効な整数を持つことを確認
        let userDoc = get(userPath);
        let hasValidSiteCount = userDoc.data != null && userDoc.data.siteCount is int;
        // プレミアム判定はサブスクリプションドキュメントで行う
        let isPremium = isPremiumUser();
        let limit = isPremium ? 30 : 3;
        return hasValidSiteCount && userDoc.data.siteCount < limit;
      }
      
      // サイトサブコレクション - ユーザー配下に存在
      match /sites/{siteId} {
        // 自分のユーザーID配下のサイトのみアクセス可能
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // サイト作成時のバリデーション
        allow create: if request.auth != null 
          && request.auth.uid == userId
          && validateSiteData()
          && siteCreationAllowed();
        
        // サイト更新時のバリデーション
        allow update: if request.auth != null 
          && request.auth.uid == userId
          && validateSiteData();

        // サイト削除（データ検証不要）
        allow delete: if request.auth != null 
          && request.auth.uid == userId;
        
        // サイトデータのバリデーション関数
        function validateSiteData() {
          return request.resource.data.keys().hasAll(['userId', 'url', 'name', 'monitoringEnabled', 'checkInterval', 'createdAt'])
            && request.resource.data.url is string
            && request.resource.data.url.size() > 0
            && request.resource.data.name is string
            && request.resource.data.name.size() > 0
            && request.resource.data.monitoringEnabled is bool
            && request.resource.data.checkInterval is int
            && request.resource.data.checkInterval >= 5
            && request.resource.data.checkInterval <= 1440; // 5分〜24時間
        }
      }
      
      // 監視結果サブコレクション - ユーザー配下に存在
      match /monitoringResults/{resultId} {
        // 自分のユーザーID配下の監視結果のみアクセス可能
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // リンクチェック結果サブコレクション - ユーザー配下に存在
      match /linkCheckResults/{resultId} {
        // 自分のユーザーID配下のリンクチェック結果のみアクセス可能
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
        
        // 壊れたリンクサブコレクション - linkCheckResults配下に存在
        match /brokenLinks/{linkId} {
          // 親のlinkCheckResultsと同じユーザーのみアクセス可能
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
      
      // 壊れたリンクサブコレクション - ユーザー配下（レガシー、削除予定）
      match /brokenLinks/{linkId} {
        // 自分のユーザーID配下の壊れたリンクのみアクセス可能（読み取り専用）
        allow read: if request.auth != null && request.auth.uid == userId;
      }
      
      // アラートサブコレクション - ユーザー配下に存在
      match /alerts/{alertId} {
        // 自分のユーザーID配下のアラートのみアクセス可能
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // 統計サブコレクション - ユーザー配下に存在
      match /statistics/{statId} {
        // 自分のユーザーID配下の統計のみアクセス可能
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // サブスクリプション情報サブコレクション - ユーザー配下に存在
      match /subscription/{subscriptionId} {
        // 自分のユーザーID配下のサブスクリプション情報のみアクセス可能
        allow read: if request.auth != null && request.auth.uid == userId;
        // 書き込み・削除は Cloud Functions 側でのみ実施（直接書き込みは禁止）
        allow create, update, delete: if false;
      }
      
      // モニタリング結果サブコレクション - ユーザー配下に存在
      match /monitoringResults/{resultId} {
        // 自分のユーザーID配下のモニタリング結果のみアクセス可能（クライアント読み書き許可）
        allow read: if request.auth != null && request.auth.uid == userId;
        // クライアントからの書き込みを許可（自分のユーザーID配下のみ）
        allow create, update: if request.auth != null && request.auth.uid == userId;
        // 削除は Cloud Functions 側でのみ実施（アカウント削除時）
        allow delete: if false;
      }
      
      // リンク検査結果サブコレクション - ユーザー配下に存在
      match /linkCheckResults/{checkId} {
        // 自分のユーザーID配下のリンク検査結果のみアクセス可能（クライアント読み書き許可）
        allow read: if request.auth != null && request.auth.uid == userId;
        // クライアントからの書き込みを許可（自分のユーザーID配下のみ）
        allow create, update: if request.auth != null && request.auth.uid == userId;
        // 削除は Cloud Functions 側でのみ実施（アカウント削除時）
        allow delete: if false;
        
        // リンク切れサブコレクション
        match /brokenLinks/{linkId} {
          // 自分のユーザーID配下のリンク切れ情報のみアクセス可能（クライアント読み書き許可）
          allow read: if request.auth != null && request.auth.uid == userId;
          // クライアントからの書き込みを許可
          allow create, update: if request.auth != null && request.auth.uid == userId;
          // 削除は Cloud Functions 側でのみ実施（アカウント削除時）
          allow delete: if false;
        }
      }
    }
  }
}
