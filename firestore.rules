rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザーコレクション - 階層構造のルートレベル
    match /users/{userId} {
      // ユーザープロフィールへのアクセス（自分のみ）
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // サイトサブコレクション - ユーザー配下に存在
      match /sites/{siteId} {
        // 自分のユーザーID配下のサイトのみアクセス可能
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // サイト作成時のバリデーション
        allow create: if request.auth != null 
          && request.auth.uid == userId
          && validateSiteData();
        
        // サイト更新時のバリデーション
        allow update: if request.auth != null 
          && request.auth.uid == userId
          && validateSiteData();
        
        // サイトデータのバリデーション関数
        function validateSiteData() {
          return request.resource.data.keys().hasAll(['userId', 'url', 'name', 'monitoringEnabled', 'checkInterval', 'createdAt'])
            && request.resource.data.url is string
            && request.resource.data.url.size() > 0
            && request.resource.data.name is string
            && request.resource.data.name.size() > 0
            && request.resource.data.monitoringEnabled is bool
            && request.resource.data.checkInterval is int
            && request.resource.data.checkInterval >= 5
            && request.resource.data.checkInterval <= 1440; // 5分〜24時間
        }
      }
      
      // 監視結果サブコレクション - ユーザー配下に存在
      match /monitoringResults/{resultId} {
        // 自分のユーザーID配下の監視結果のみアクセス可能
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // リンクチェック結果サブコレクション - ユーザー配下に存在
      match /linkCheckResults/{resultId} {
        // 自分のユーザーID配下のリンクチェック結果のみアクセス可能
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
        
        // 壊れたリンクサブコレクション - linkCheckResults配下に存在
        match /brokenLinks/{linkId} {
          // 親のlinkCheckResultsと同じユーザーのみアクセス可能
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
      
      // 壊れたリンクサブコレクション - ユーザー配下（レガシー、削除予定）
      match /brokenLinks/{linkId} {
        // 自分のユーザーID配下の壊れたリンクのみアクセス可能（読み取り専用）
        allow read: if request.auth != null && request.auth.uid == userId;
      }
      
      // アラートサブコレクション - ユーザー配下に存在
      match /alerts/{alertId} {
        // 自分のユーザーID配下のアラートのみアクセス可能
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // 統計サブコレクション - ユーザー配下に存在
      match /statistics/{statId} {
        // 自分のユーザーID配下の統計のみアクセス可能
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
